---
import BaseLayout from '../../layouts/BaseLayout.astro';
import { getCategoriasFormularios, getStrapiImageUrl } from '../../lib/strapi';
import { languages, useTranslations, type Locale, getLocalizedPath } from '../../i18n/utils';

export const prerender = false;

const { lang } = Astro.params;
const locale = lang as Locale;
const t = useTranslations(locale);

// Obtener categorías y formularios desde Strapi con el locale
const categoriasStrapi = await getCategoriasFormularios(locale);

// Mapear datos de Strapi
const categorias = categoriasStrapi.map(cat => ({
	titulo: cat.titulo,
	icono: cat.icono,
	color: cat.color,
	descripcion: cat.descripcion,
	formularios: cat.formularios.map(form => ({
		nombre: form.nombre,
		descripcion: form.descripcion,
		formato: form.formato,
		tamano: form.tamano || 'N/A',
		url: form.archivo ? getStrapiImageUrl(form.archivo.url) : '#',
		imagen: form.thumbnail ? getStrapiImageUrl(form.thumbnail.url) : '/images/logo_01.png'
	}))
}));

// Rutas localizadas
const basePath = `/${lang}/descarga_formularios`;
const contactPath = getLocalizedPath('/contacto', locale);
const agenciesPath = getLocalizedPath('/nuestras_agencias', locale);
---

<BaseLayout title={t('forms.pageTitle')} description={t('forms.pageSubtitle')} currentPath={basePath}>
	<!-- Page Header -->
	<div class="page-header">
		<div class="container">
			<h1><i class="fas fa-download"></i> {t('forms.title')}</h1>
			<p>{t('forms.pageSubtitle')}</p>
		</div>
	</div>

	<!-- Main Content -->
	<div class="main-content">
		<div class="container">
			<!-- Instrucciones rápidas -->
			<div class="instrucciones-rapidas">
				<div class="instruccion">
					<i class="fas fa-search"></i>
					<span>{t('forms.step1')}</span>
				</div>
				<div class="divider">→</div>
				<div class="instruccion">
					<i class="fas fa-download"></i>
					<span>{t('forms.step2')}</span>
				</div>
				<div class="divider">→</div>
				<div class="instruccion">
					<i class="fas fa-building"></i>
					<span>{t('forms.step3')}</span>
				</div>
			</div>

			<!-- Buscador de Formularios -->
			<div class="search-container">
				<div class="search-box">
					<i class="fas fa-search search-icon"></i>
					<input
						type="text"
						id="searchInput"
						class="search-input"
						placeholder={t('forms.searchPlaceholder')}
					/>
					<button id="clearSearch" class="clear-btn" style="display: none;">
						<i class="fas fa-times"></i>
					</button>
				</div>
				<div class="filter-buttons">
					<button class="filter-btn active" data-filter="all">
						<i class="fas fa-th"></i> {t('forms.all')}
					</button>
					<button class="filter-btn" data-filter="PDF">
						<i class="fas fa-file-pdf"></i> {t('forms.pdf')}
					</button>
					<button class="filter-btn" data-filter="Excel">
						<i class="fas fa-file-excel"></i> {t('forms.excel')}
					</button>
				</div>
			</div>

			<div id="searchResults" class="search-results" style="display: none;">
				<div class="results-header">
					<span id="resultsCount"></span>
					<button id="closeResults" class="btn-close-results">
						<i class="fas fa-times"></i> {t('forms.closeSearch')}
					</button>
				</div>
				<div id="resultsContainer" class="formularios-grid"></div>
			</div>

			<!-- Categorías de Formularios -->
			{categorias.map((categoria) => (
				<div class="categoria-section">
					<div class="categoria-header">
						<div class="categoria-icon" style={`background: ${categoria.color}`}>
							<i class={categoria.icono}></i>
						</div>
						<div class="categoria-info">
							<h2>{categoria.titulo}</h2>
							<p>{categoria.descripcion}</p>
						</div>
						<span class="badge-count">{categoria.formularios.length} {t('forms.formsCount')}</span>
					</div>

					<div class="formularios-grid">
						{categoria.formularios.map((form) => (
							<div class="formulario-card">
								<div class="card-thumbnail">
									<img src={form.imagen} alt={form.nombre} />
									<div class="badge-overlay">
										<span class={`badge badge-${form.formato.toLowerCase()}`}>
											<i class={form.formato === 'PDF' ? 'fas fa-file-pdf' : 'fas fa-file-excel'}></i>
											{form.formato}
										</span>
									</div>
								</div>
								<div class="card-content">
									<h3>{form.nombre}</h3>
									<p>{form.descripcion}</p>
									<div class="card-footer">
										<span class="card-size">
											<i class="fas fa-file"></i> {form.tamano}
										</span>
										<a href={form.url} class="btn-download" download>
											<i class="fas fa-download"></i> {t('common.download')}
										</a>
									</div>
								</div>
							</div>
						))}
					</div>
				</div>
			))}

			<!-- Información adicional -->
			<div class="info-footer">
				<div class="row">
					<div class="col-md-6">
						<div class="info-card">
							<div class="info-icon">
								<i class="fas fa-question-circle"></i>
							</div>
							<div class="info-content">
								<h3>{t('forms.needHelp')}</h3>
								<p>{t('forms.helpDescription')}</p>
								<a href={contactPath} class="info-link">
									{t('forms.contactSupport')} <i class="fas fa-arrow-right"></i>
								</a>
							</div>
						</div>
					</div>
					<div class="col-md-6">
						<div class="info-card">
							<div class="info-icon">
								<i class="fas fa-map-marker-alt"></i>
							</div>
							<div class="info-content">
								<h3>{t('forms.ourOffices')}</h3>
								<p>{t('forms.officesDescription')}</p>
								<a href={agenciesPath} class="info-link">
									{t('forms.viewLocations')} <i class="fas fa-arrow-right"></i>
								</a>
							</div>
						</div>
					</div>
				</div>
			</div>
		</div>
	</div>
</BaseLayout>

<style>
	/* Page Header */
	.page-header {
		background: linear-gradient(135deg, #8c1b12 0%, #6d2018 100%);
		padding: 3rem 0;
		color: white;
		text-align: center;
		margin-bottom: 3rem;
	}

	.page-header h1 {
		font-size: 36px;
		font-weight: 700;
		margin-bottom: 0.5rem;
		display: flex;
		align-items: center;
		justify-content: center;
		gap: 1rem;
	}

	.page-header p {
		font-size: 16px;
		opacity: 0.95;
		margin: 0;
	}

	/* Main Content */
	.main-content {
		padding-bottom: 4rem;
	}

	/* Instrucciones Rápidas */
	.instrucciones-rapidas {
		display: flex;
		justify-content: center;
		align-items: center;
		gap: 3rem;
		margin-bottom: 4rem;
		padding: 2.5rem;
		background: white;
		border-radius: 16px;
		box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
	}

	.instruccion {
		display: flex;
		flex-direction: column;
		align-items: center;
		gap: 0.8rem;
		font-weight: 600;
		color: #333;
		text-align: center;
	}

	.instruccion i {
		width: 50px;
		height: 50px;
		background: linear-gradient(135deg, #8c1b12 0%, #6d2018 100%);
		color: white;
		border-radius: 50%;
		display: flex;
		align-items: center;
		justify-content: center;
		font-size: 20px;
	}

	.divider {
		color: #8c1b12;
		font-size: 24px;
		font-weight: 700;
	}

	/* Categoria Section */
	.categoria-section {
		margin-bottom: 4rem;
	}

	.categoria-header {
		display: flex;
		align-items: center;
		gap: 1.5rem;
		padding: 2rem;
		background: white;
		border-radius: 12px;
		box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
		margin-bottom: 2rem;
	}

	.categoria-icon {
		width: 70px;
		height: 70px;
		border-radius: 12px;
		display: flex;
		align-items: center;
		justify-content: center;
		flex-shrink: 0;
	}

	.categoria-icon i {
		font-size: 32px;
		color: white;
	}

	.categoria-info {
		flex: 1;
	}

	.categoria-info h2 {
		font-size: 24px;
		font-weight: 700;
		color: #333;
		margin: 0 0 0.5rem 0;
	}

	.categoria-info p {
		font-size: 14px;
		color: #666;
		margin: 0;
	}

	.badge-count {
		background: #f0f0f0;
		color: #666;
		padding: 8px 16px;
		border-radius: 20px;
		font-size: 13px;
		font-weight: 600;
		white-space: nowrap;
	}

	/* Formularios Grid */
	.formularios-grid {
		display: grid;
		grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
		gap: 2rem;
	}

	/* Formulario Card */
	.formulario-card {
		background: white;
		border-radius: 12px;
		overflow: hidden;
		box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
		transition: all 0.3s ease;
		display: flex;
		flex-direction: column;
		height: 100%;
	}

	.formulario-card:hover {
		transform: translateY(-8px);
		box-shadow: 0 8px 24px rgba(0, 0, 0, 0.15);
	}

	.card-thumbnail {
		position: relative;
		width: 100%;
		height: 180px;
		background: linear-gradient(135deg, #f5f5f5 0%, #e8e8e8 100%);
		display: flex;
		align-items: center;
		justify-content: center;
		padding: 0;
		overflow: hidden;
	}

	.card-thumbnail img {
		width: 100%;
		height: 100%;
		object-fit: cover;
		object-position: center;
		opacity: 0.9;
		transition: all 0.3s ease;
	}

	.formulario-card:hover .card-thumbnail img {
		transform: scale(1.1);
		opacity: 1;
	}

	.badge-overlay {
		position: absolute;
		top: 12px;
		right: 12px;
	}

	.badge {
		display: inline-flex;
		align-items: center;
		gap: 6px;
		padding: 6px 12px;
		border-radius: 6px;
		font-size: 11px;
		font-weight: 700;
		text-transform: uppercase;
		letter-spacing: 0.5px;
		box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
	}

	.badge-pdf {
		background: #dc3545;
		color: white;
	}

	.badge-excel {
		background: #217346;
		color: white;
	}

	.card-content {
		padding: 1.5rem;
		display: flex;
		flex-direction: column;
		flex: 1;
	}

	.card-content h3 {
		font-size: 17px;
		font-weight: 700;
		color: #333;
		margin: 0 0 0.8rem 0;
		line-height: 1.4;
		min-height: 48px;
	}

	.card-content p {
		font-size: 14px;
		color: #666;
		line-height: 1.6;
		margin: 0 0 1.5rem 0;
		flex: 1;
	}

	.card-footer {
		display: flex;
		align-items: center;
		justify-content: space-between;
		padding-top: 1rem;
		border-top: 1px solid #f0f0f0;
	}

	.card-size {
		font-size: 13px;
		color: #999;
		display: flex;
		align-items: center;
		gap: 6px;
	}

	.card-size i {
		font-size: 12px;
	}

	.btn-download {
		display: inline-flex;
		align-items: center;
		gap: 6px;
		padding: 8px 16px;
		background: #8c1b12;
		color: white;
		text-decoration: none;
		border-radius: 6px;
		font-size: 13px;
		font-weight: 600;
		transition: all 0.2s ease;
	}

	.btn-download:hover {
		background: #6d2018;
		transform: translateY(-2px);
		box-shadow: 0 4px 8px rgba(140, 27, 18, 0.3);
		color: white;
	}

	/* Info Footer */
	.info-footer {
		margin-top: 4rem;
		padding-top: 3rem;
		border-top: 2px solid #f0f0f0;
	}

	.info-card {
		display: flex;
		gap: 1.5rem;
		padding: 2.5rem;
		background: white;
		border-radius: 16px;
		box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
		height: 100%;
		transition: all 0.3s ease;
		margin-bottom: 2rem;
	}

	.info-card:hover {
		transform: translateY(-4px);
		box-shadow: 0 8px 24px rgba(0, 0, 0, 0.12);
	}

	.info-icon {
		width: 60px;
		height: 60px;
		background: linear-gradient(135deg, #8c1b12 0%, #6d2018 100%);
		border-radius: 12px;
		display: flex;
		align-items: center;
		justify-content: center;
		flex-shrink: 0;
	}

	.info-icon i {
		font-size: 28px;
		color: white;
	}

	.info-content {
		flex: 1;
	}

	.info-content h3 {
		font-size: 20px;
		font-weight: 700;
		color: #333;
		margin: 0 0 0.8rem 0;
	}

	.info-content p {
		font-size: 15px;
		color: #666;
		line-height: 1.6;
		margin: 0 0 1.2rem 0;
	}

	.info-link {
		color: #8c1b12;
		text-decoration: none;
		font-weight: 600;
		font-size: 15px;
		transition: all 0.2s ease;
		display: inline-flex;
		align-items: center;
		gap: 8px;
	}

	.info-link:hover {
		color: #6d2018;
		gap: 12px;
	}

	.info-link i {
		font-size: 12px;
		transition: transform 0.2s ease;
	}

	.info-link:hover i {
		transform: translateX(4px);
	}

	/* Mobile Responsive */
	@media (max-width: 991px) {
		.instrucciones-rapidas {
			flex-direction: column;
			gap: 1.5rem;
			padding: 2rem;
		}

		.divider {
			transform: rotate(90deg);
		}

		.formularios-grid {
			grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
			gap: 1.5rem;
		}

		.categoria-header {
			flex-wrap: wrap;
		}

		.badge-count {
			width: 100%;
			text-align: center;
			margin-top: 1rem;
		}
	}

	@media (max-width: 767px) {
		.page-header h1 {
			font-size: 28px;
			flex-direction: column;
			gap: 0.5rem;
		}

		.formularios-grid {
			grid-template-columns: 1fr;
		}

		.categoria-header {
			padding: 1.5rem;
		}

		.categoria-icon {
			width: 60px;
			height: 60px;
		}

		.categoria-icon i {
			font-size: 28px;
		}

		.categoria-info h2 {
			font-size: 20px;
		}

		.info-card {
			flex-direction: column;
			text-align: center;
			padding: 2rem;
		}

		.info-icon {
			margin: 0 auto;
		}

		.info-link {
			justify-content: center;
		}
	}

	/* Search Container */
	.search-container {
		margin-bottom: 3rem;
		background: white;
		padding: 2rem;
		border-radius: 16px;
		box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
	}

	.search-box {
		position: relative;
		margin-bottom: 1.5rem;
	}

	.search-icon {
		position: absolute;
		left: 1.5rem;
		top: 50%;
		transform: translateY(-50%);
		color: #999;
		font-size: 18px;
		pointer-events: none;
	}

	.search-input {
		width: 100%;
		padding: 1rem 3.5rem 1rem 4rem;
		border: 2px solid #e0e0e0;
		border-radius: 50px;
		font-size: 15px;
		transition: all 0.3s ease;
		background: #f8f9fa;
	}

	.search-input:focus {
		outline: none;
		border-color: #8c1b12;
		background: white;
		box-shadow: 0 4px 12px rgba(140, 27, 18, 0.1);
	}

	.clear-btn {
		position: absolute;
		right: 1rem;
		top: 50%;
		transform: translateY(-50%);
		background: #e0e0e0;
		border: none;
		width: 32px;
		height: 32px;
		border-radius: 50%;
		cursor: pointer;
		transition: all 0.2s ease;
		display: flex;
		align-items: center;
		justify-content: center;
	}

	.clear-btn:hover {
		background: #8c1b12;
		color: white;
	}

	.filter-buttons {
		display: flex;
		gap: 1rem;
		flex-wrap: wrap;
	}

	.filter-btn {
		padding: 0.75rem 1.5rem;
		border: 2px solid #e0e0e0;
		background: white;
		border-radius: 50px;
		font-size: 14px;
		font-weight: 600;
		cursor: pointer;
		transition: all 0.2s ease;
		display: flex;
		align-items: center;
		gap: 0.5rem;
	}

	.filter-btn:hover {
		border-color: #8c1b12;
		color: #8c1b12;
	}

	.filter-btn.active {
		background: #8c1b12;
		border-color: #8c1b12;
		color: white;
	}

	.filter-btn i {
		font-size: 16px;
	}

	/* Search Results */
	.search-results {
		margin-bottom: 3rem;
	}

	.results-header {
		display: flex;
		justify-content: space-between;
		align-items: center;
		padding: 1.5rem;
		background: white;
		border-radius: 12px 12px 0 0;
		border-bottom: 2px solid #f0f0f0;
	}

	#resultsCount {
		font-weight: 700;
		color: #333;
		font-size: 16px;
	}

	.btn-close-results {
		background: #f0f0f0;
		border: none;
		padding: 0.5rem 1rem;
		border-radius: 6px;
		cursor: pointer;
		font-size: 14px;
		font-weight: 600;
		color: #666;
		transition: all 0.2s ease;
		display: flex;
		align-items: center;
		gap: 0.5rem;
	}

	.btn-close-results:hover {
		background: #8c1b12;
		color: white;
	}

	#resultsContainer {
		background: white;
		padding: 2rem;
		border-radius: 0 0 12px 12px;
	}

	.categoria-section.hidden {
		display: none;
	}

	@media (max-width: 767px) {
		.search-container {
			padding: 1.5rem;
		}

		.filter-buttons {
			justify-content: center;
		}

		.filter-btn {
			flex: 1;
			min-width: 100px;
			justify-content: center;
		}

		.results-header {
			flex-direction: column;
			gap: 1rem;
			text-align: center;
		}
	}
</style>

<script define:vars={{ foundSingular: t('forms.foundSingular'), foundPlural: t('forms.foundPlural'), noResults: t('forms.noResults') }}>
	document.addEventListener('DOMContentLoaded', () => {
		const searchInput = document.getElementById('searchInput');
		const clearSearch = document.getElementById('clearSearch');
		const filterButtons = document.querySelectorAll('.filter-btn');
		const searchResults = document.getElementById('searchResults');
		const resultsContainer = document.getElementById('resultsContainer');
		const resultsCount = document.getElementById('resultsCount');
		const closeResults = document.getElementById('closeResults');
		const categoriaSections = document.querySelectorAll('.categoria-section');

		let currentFilter = 'all';
		let allFormularios = [];

		// Recopilar todos los formularios
		categoriaSections.forEach((section) => {
			const categoryTitle = section.querySelector('.categoria-titulo h2, .categoria-info h2')?.textContent || '';
			const cards = section.querySelectorAll('.formulario-card');

			cards.forEach((card) => {
				const nombre = card.querySelector('h3')?.textContent || '';
				const formato = card.querySelector('.badge')?.textContent?.trim() || '';
				const cardClone = card.cloneNode(true);

				allFormularios.push({
					nombre,
					formato,
					categoria: categoryTitle,
					element: cardClone
				});
			});
		});

		// Función de búsqueda
		function performSearch() {
			const query = searchInput.value.toLowerCase().trim();

			if (query === '' && currentFilter === 'all') {
				// Mostrar todo
				searchResults.style.display = 'none';
				categoriaSections.forEach(section => {
					section.classList.remove('hidden');
				});
				return;
			}

			// Filtrar formularios
			let filtered = allFormularios.filter(form => {
				const matchesQuery = query === '' ||
					form.nombre.toLowerCase().includes(query) ||
					form.categoria.toLowerCase().includes(query);

				const matchesFilter = currentFilter === 'all' || form.formato === currentFilter;

				return matchesQuery && matchesFilter;
			});

			// Mostrar resultados
			if (filtered.length > 0) {
				resultsContainer.innerHTML = '';
				filtered.forEach(form => {
					resultsContainer.appendChild(form.element.cloneNode(true));
				});

				resultsCount.textContent = `${filtered.length} ${filtered.length !== 1 ? foundPlural : foundSingular}`;
				searchResults.style.display = 'block';

				// Ocultar categorías
				categoriaSections.forEach(section => {
					section.classList.add('hidden');
				});
			} else {
				resultsContainer.innerHTML = `<p style="text-align: center; color: #999; padding: 3rem;">${noResults}</p>`;
				resultsCount.textContent = `0 ${foundPlural}`;
				searchResults.style.display = 'block';

				categoriaSections.forEach(section => {
					section.classList.add('hidden');
				});
			}
		}

		// Event listeners
		searchInput.addEventListener('input', () => {
			clearSearch.style.display = searchInput.value ? 'flex' : 'none';
			performSearch();
		});

		clearSearch.addEventListener('click', () => {
			searchInput.value = '';
			clearSearch.style.display = 'none';
			currentFilter = 'all';

			// Reset filter buttons
			filterButtons.forEach(btn => btn.classList.remove('active'));
			filterButtons[0].classList.add('active');

			performSearch();
		});

		filterButtons.forEach(btn => {
			btn.addEventListener('click', () => {
				filterButtons.forEach(b => b.classList.remove('active'));
				btn.classList.add('active');
				currentFilter = btn.getAttribute('data-filter') || 'all';
				performSearch();
			});
		});

		closeResults.addEventListener('click', () => {
			searchInput.value = '';
			clearSearch.style.display = 'none';
			currentFilter = 'all';

			// Reset filter buttons
			filterButtons.forEach(btn => btn.classList.remove('active'));
			filterButtons[0].classList.add('active');

			searchResults.style.display = 'none';
			categoriaSections.forEach(section => {
				section.classList.remove('hidden');
			});
		});
	});
</script>
