---
/**
 * Layout para páginas de prestaciones individuales
 * Carga datos desde Strapi y renderiza el contenido dinámicamente
 */
import BaseLayout from './BaseLayout.astro';
import Breadcrumb from '../components/Breadcrumb.astro';
import PrestacionesGrid from '../components/PrestacionesGrid.astro';
import PartnersCarousel from '../components/PartnersCarousel.astro';
import { getPrestacionBySlug, getStrapiImageUrl, richTextToPlainText, getSocios } from '../lib/strapi';
import { getLangFromUrl, useTranslations, getLocalizedPath } from '../i18n/utils';

interface Props {
  slug: string; // Slug de Strapi (kebab-case)
  pageTitle: string; // Título para SEO
  breadcrumbTitle: string; // Título para el breadcrumb
  currentPath: string; // Path actual para navegación
  defaultDescripcion?: string; // Descripción por defecto si no hay en Strapi
  defaultRequisitos?: string; // Requisitos por defecto si no hay en Strapi
  defaultImagen?: string; // Imagen por defecto si no hay en Strapi
}

const {
  slug,
  pageTitle,
  breadcrumbTitle,
  currentPath,
  defaultDescripcion = '',
  defaultRequisitos = '',
  defaultImagen = '/images/prestaciones/prestaciones_detail_01.jpg'
} = Astro.props;

// Detectar idioma y cargar traducciones
const lang = getLangFromUrl(Astro.url);
const t = useTranslations(lang);

// Mapeo de slug español de Strapi a slugs localizados por idioma
const slugsByLocale: Record<string, Record<string, string>> = {
  'pension-por-vejez': {
    es: 'pension-por-vejez',
    en: 'old-age-pension',
    fr: 'pension-de-retraite',
    pt: 'pensao-por-velhice'
  },
  'prestaciones-medico-farmaceuticas': {
    es: 'prestaciones-medico-farmaceuticas',
    en: 'medical-pharmaceutical-benefits',
    fr: 'prestations-medico-pharmaceutiques',
    pt: 'beneficios-medico-farmaceuticos'
  },
  'subsidio-de-incapacidad-temporal': {
    es: 'subsidio-de-incapacidad-temporal',
    en: 'temporary-disability-allowance',
    fr: 'allocation-dincapacite-temporaire',
    pt: 'subsidio-de-incapacidade-temporaria'
  },
  'subsidio-por-maternidad': {
    es: 'subsidio-por-maternidad',
    en: 'maternity-allowance',
    fr: 'allocation-de-maternite',
    pt: 'subsidio-de-maternidade'
  },
  'prestaciones-por-invalidez': {
    es: 'prestaciones-por-invalidez',
    en: 'disability-benefits',
    fr: 'prestations-dinvalidite',
    pt: 'prestacoes-por-invalidez'
  },
  'prestaciones-por-muerte-y-supervivencia': {
    es: 'prestaciones-por-muerte-y-supervivencia',
    en: 'death-and-survivors-benefits',
    fr: 'prestations-de-deces-et-de-survie',
    pt: 'prestacoes-por-morte-e-sobrevivencia'
  },
  'proteccion-al-empleo': {
    es: 'proteccion-al-empleo',
    en: 'employment-protection',
    fr: 'protection-de-lemploi',
    pt: 'protecao-ao-emprego'
  },
  'subsidios-familiares': {
    es: 'subsidios-familiares',
    en: 'family-allowances',
    fr: 'allocations-familiales',
    pt: 'subsidios-familiares'
  },
  'servicios-sociales': {
    es: 'servicios-sociales',
    en: 'social-services',
    fr: 'services-sociaux',
    pt: 'servicos-sociais'
  }
};

// Obtener el slug localizado para Strapi
const localizedSlug = slugsByLocale[slug]?.[lang] || slug;

// Cargar datos desde Strapi con el idioma y slug correctos
const prestacion = await getPrestacionBySlug(localizedSlug, lang);
const socios = await getSocios();

// Usar datos de Strapi o valores por defecto
const titulo = prestacion?.titulo || breadcrumbTitle;
const descripcion = richTextToPlainText(prestacion?.descripcion) || defaultDescripcion;
const requisitos = prestacion?.requisitos || defaultRequisitos;
const imagenDetalle = prestacion?.imagenDetalle
  ? getStrapiImageUrl(prestacion.imagenDetalle.url)
  : (prestacion?.imagen ? getStrapiImageUrl(prestacion.imagen.url) : defaultImagen);

// Convertir requisitos a array
const requisitosArray = requisitos?.split('\n').filter(r => r.trim()) || [];
---

<BaseLayout title={pageTitle} currentPath={currentPath}>
  <Breadcrumb
    title={titulo}
    items={[
      { label: t('prestaciones.title'), href: getLocalizedPath('/Prestaciones_Sociales', lang) }
    ]}
  />

  <div class="blog-main">
    <div class="container">
      <div class="row">
        <!-- Post Content Column -->
        <div class="col-lg-8">
          <!-- Preview Image -->
          <img class="img-fluid rounded" src={imagenDetalle} alt={titulo} />
          <hr>

          {descripcion && (
            <blockquote class="blockquote">
              <p class="mb-0">{descripcion}</p>
            </blockquote>
          )}
        </div>

        <!-- Sidebar Column -->
        <div class="col-md-4 blog-right-side">
          {requisitosArray.length > 0 && (
            <div class="card my-4">
              <h5 class="card-header">{t('prestacionDetail.requirements')}:</h5>
              <div class="card-body">
                <ul>
                  {requisitosArray.map((req) => (
                    <li><h6 set:html={req.replace(/^-\s*/, '')} /></li>
                  ))}
                </ul>
              </div>
            </div>
          )}
        </div>
      </div>
    </div>
  </div>

  <PrestacionesGrid usarStrapi={true} />

  <PartnersCarousel socios={socios} />

  <div class="touch-line">
    <div class="container">
      <div class="row">
        <div class="col-md-8">
          <p></p>
        </div>
        <div class="col-md-4">
          <a class="btn btn-lg btn-secondary btn-block" href={getLocalizedPath('/contacto', lang)}> {t('common.contactUs')} </a>
        </div>
      </div>
    </div>
  </div>
</BaseLayout>

<script is:inline src="/js/owl.carousel.min.js"></script>
<script is:inline src="/js/owl.carousel_2.js"></script>
<script is:inline src="/js/script.js"></script>
